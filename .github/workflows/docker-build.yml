name: Docker Build and Push

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version tag (e.g., 1.0.0)"
                required: true
                type: string

env:
    REGISTRY: ghcr.io
    KEYCLOAK_IMAGE: ${{ github.repository_owner }}/keycloak
    APP_IMAGE: ${{ github.repository_owner }}/agora-mvp
    CADDY_IMAGE: ${{ github.repository_owner }}/caddy

jobs:
    extract-version:
        runs-on: ubuntu-24.04
        outputs:
            version: ${{ steps.extract.outputs.version }}
        steps:
            - name: Extract version from tag
              id: extract
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION="${GITHUB_REF#refs/tags/v}"
                  fi
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Extracted version: ${VERSION}"

    build-keycloak:
        needs: extract-version
        runs-on: ubuntu-24.04
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Buildah
              run: sudo apt-get update -y && sudo apt install -y buildah

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.KEYCLOAK_IMAGE }}
                  tags: |
                      type=raw,value=${{ needs.extract-version.outputs.version }}
                      type=raw,value=latest

            - name: Build Keycloak image
              uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2.13
              with:
                  context: ./docker/keycloak
                  containerfiles: ./docker/keycloak/Containerfile
                  platforms: linux/amd64,linux/arm64
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Push Keycloak image
              uses: redhat-actions/push-to-registry@5ed88d269cf581ea9ef6dd6806d01562096bee9c # v2.8
              with:
                  image: ${{ env.REGISTRY }}/${{ env.KEYCLOAK_IMAGE }}
                  tags: ${{ steps.meta.outputs.tags }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

    # build-app:
    #     needs: extract-version
    #     runs-on: ubuntu-24.04
    #     permissions:
    #         contents: read
    #         packages: write
    #     steps:
    #         - name: Checkout repository
    #           uses: actions/checkout@v4

    #         - name: Set up Docker Buildx
    #           uses: docker/setup-buildx-action@v3

    #         - name: Log in to GHCR
    #           uses: docker/login-action@v3
    #           with:
    #               registry: ${{ env.REGISTRY }}
    #               username: ${{ github.actor }}
    #               password: ${{ secrets.GITHUB_TOKEN }}

    #         - name: Extract metadata
    #           id: meta
    #           uses: docker/metadata-action@v5
    #           with:
    #               images: ${{ env.REGISTRY }}/${{ env.APP_IMAGE }}
    #               tags: |
    #                   type=raw,value=${{ needs.extract-version.outputs.version }}
    #                   type=raw,value=latest

    #         - name: Build and push Django app image
    #           uses: docker/build-push-action@v5
    #           with:
    #               context: .
    #               file: ./docker/app/Dockerfile
    #               platforms: linux/amd64,linux/arm64
    #               push: true
    #               tags: ${{ steps.meta.outputs.tags }}
    #               labels: ${{ steps.meta.outputs.labels }}
    #               cache-from: type=gha
    #               cache-to: type=gha,mode=max

    # build-caddy:
    #     needs: extract-version
    #     runs-on: ubuntu-24.04
    #     permissions:
    #         contents: read
    #         packages: write
    #     steps:
    #         - name: Checkout repository
    #           uses: actions/checkout@v4

    #         - name: Set up Docker Buildx
    #           uses: docker/setup-buildx-action@v3

    #         - name: Log in to GHCR
    #           uses: docker/login-action@v3
    #           with:
    #               registry: ${{ env.REGISTRY }}
    #               username: ${{ github.actor }}
    #               password: ${{ secrets.GITHUB_TOKEN }}

    #         - name: Extract metadata
    #           id: meta
    #           uses: docker/metadata-action@v5
    #           with:
    #               images: ${{ env.REGISTRY }}/${{ env.CADDY_IMAGE }}
    #               tags: |
    #                   type=raw,value=${{ needs.extract-version.outputs.version }}
    #                   type=raw,value=latest

    #         - name: Build and push Caddy image
    #           uses: docker/build-push-action@v5
    #           with:
    #               context: ./docker/caddy
    #               file: ./docker/caddy/Dockerfile
    #               platforms: linux/amd64,linux/arm64
    #               push: true
    #               tags: ${{ steps.meta.outputs.tags }}
    #               labels: ${{ steps.meta.outputs.labels }}
    #               cache-from: type=gha
    #               cache-to: type=gha,mode=max
